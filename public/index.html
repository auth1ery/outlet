<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>outlet</title>
  <style>
    :root[data-theme="dark"] {
      --bg-primary: #36393f;
      --bg-secondary: #2f3136;
      --bg-tertiary: #202225;
      --bg-input: #40444b;
      --text-primary: #dcddde;
      --text-secondary: #b9bbbe;
      --text-muted: #72767d;
      --accent: #5865f2;
      --accent-hover: #4752c4;
      --online: #3ba55d;
      --error: #f04747;
      --success: #43b581;
    }
    :root[data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f2f3f5;
      --bg-tertiary: #e3e5e8;
      --bg-input: #e3e5e8;
      --text-primary: #2e3338;
      --text-secondary: #4e5058;
      --text-muted: #80848e;
      --accent: #5865f2;
      --accent-hover: #4752c4;
      --online: #3ba55d;
      --error: #f23f42;
      --success: #248046;
    }
    :root[data-theme="midnight"] {
      --bg-primary: #0f1419;
      --bg-secondary: #15202b;
      --bg-tertiary: #192734;
      --bg-input: #253341;
      --text-primary: #f7f9f9;
      --text-secondary: #8b98a5;
      --text-muted: #5b6770;
      --accent: #1d9bf0;
      --accent-hover: #1a8cd8;
      --online: #00ba7c;
      --error: #f4212e;
      --success: #00ba7c;
    }
    :root[data-theme="ocean"] {
      --bg-primary: #1a2332;
      --bg-secondary: #0d1620;
      --bg-tertiary: #0a0f18;
      --bg-input: #243447;
      --text-primary: #e8edf2;
      --text-secondary: #a1b3c4;
      --text-muted: #6b7f92;
      --accent: #4fb3d4;
      --accent-hover: #3a9cb8;
      --online: #52e0a0;
      --error: #ff6b6b;
      --success: #52e0a0;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
      transition: background-color 0.2s;
    }
    .hidden { display: none !important; }
    .app { display: flex; height: 100vh; }
    .sidebar { width: 240px; background: var(--bg-secondary); display: flex; flex-direction: column; }
    .sidebar-header { padding: 16px; border-bottom: 1px solid var(--bg-tertiary); font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
    .sidebar-content { padding: 16px; flex-grow: 1; overflow-y: auto; }
    .sidebar-footer { padding: 10px; background: var(--bg-tertiary); display: flex; justify-content: space-between; align-items: center; }
    .settings-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px; font-size: 18px; }
    .settings-btn:hover { color: var(--text-primary); }
    .online-header { font-size: 12px; margin-bottom: 8px; color: var(--text-muted); text-transform: uppercase; }
    .online-user { padding: 6px 8px; border-radius: 4px; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .online-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--online); }
    .logout-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 4px 8px; font-size: 12px; }
    .logout-btn:hover { color: var(--text-primary); }
    .chat { flex-grow: 1; display: flex; flex-direction: column; }
    .chat-header { padding: 16px; border-bottom: 1px solid var(--bg-tertiary); font-weight: 600; }
    .messages { flex-grow: 1; overflow-y: auto; padding: 16px; }
    .message { margin-bottom: 16px; display: flex; gap: 12px; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 600; overflow: hidden; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .message-content { flex: 1; }
    .message-header { margin-bottom: 4px; }
    .username { font-weight: 500; margin-right: 8px; }
    .timestamp { font-size: 12px; color: var(--text-muted); }
    .input-area { padding: 16px; }
    .typing-indicator { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; min-height: 18px; }
    .message-input { width: 100%; padding: 12px; background: var(--bg-input); border: none; border-radius: 8px; color: var(--text-primary); font-size: 14px; outline: none; font-family: inherit; }
    .auth-container { width: 100%; display: flex; align-items: center; justify-content: center; }
    .auth-box { width: 400px; padding: 32px; background: var(--bg-secondary); border-radius: 8px; }
    .auth-title { margin-bottom: 8px; text-align: center; }
    .auth-subtitle { margin-bottom: 24px; text-align: center; color: var(--text-secondary); }
    .error { padding: 12px; background: var(--error); border-radius: 4px; margin-bottom: 16px; font-size: 14px; color: white; }
    .input { width: 100%; padding: 12px; margin-bottom: 16px; background: var(--bg-tertiary); border: 1px solid var(--bg-tertiary); border-radius: 4px; color: var(--text-primary); outline: none; font-family: inherit; font-size: 14px; }
    .btn { width: 100%; padding: 12px; background: var(--accent); border: none; border-radius: 4px; color: white; font-weight: 500; cursor: pointer; margin-bottom: 8px; font-family: inherit; font-size: 14px; }
    .btn:hover { background: var(--accent-hover); }
    .btn-link { width: 100%; padding: 12px; background: transparent; border: none; color: var(--accent); cursor: pointer; font-size: 14px; font-family: inherit; }
    .btn-link:hover { text-decoration: underline; }
    .loading { display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 14px; color: var(--text-secondary); }
    .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: var(--bg-secondary); border-radius: 8px; width: 500px; max-height: 80vh; overflow-y: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid var(--bg-tertiary); font-weight: 600; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
    .modal-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 24px; }
    .modal-body { padding: 20px; }
    .setting-group { margin-bottom: 24px; }
    .setting-label { font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
    .setting-description { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
    .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .theme-option { padding: 16px; border: 2px solid var(--bg-tertiary); border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; }
    .theme-option:hover { border-color: var(--accent); }
    .theme-option.active { border-color: var(--accent); background: var(--bg-tertiary); }
    .avatar-upload { display: flex; align-items: center; gap: 16px; }
    .avatar-preview { width: 80px; height: 80px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 24px; overflow: hidden; }
    .avatar-preview img { width: 100%; height: 100%; object-fit: cover; }
    .file-input { display: none; }
    .upload-btn { padding: 8px 16px; background: var(--accent); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px; }
    .upload-btn:hover { background: var(--accent-hover); }
    .user-info { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
  </style>
</head>
<body>
  <div id="loading" class="loading">loading...</div>

  <div id="login" class="auth-container hidden">
    <div class="auth-box">
      <h2 class="auth-title">welcome to outlet</h2>
      <p class="auth-subtitle">login to continue</p>
      <div id="login-error" class="error hidden"></div>
      <form id="login-form">
        <input type="email" class="input" placeholder="email" id="login-email" required>
        <input type="password" class="input" placeholder="password" id="login-password" required>
        <button type="submit" class="btn">login</button>
      </form>
      <button class="btn-link" onclick="showRegister()">need an account? register</button>
    </div>
  </div>

  <div id="register" class="auth-container hidden">
    <div class="auth-box">
      <h2 class="auth-title">create account</h2>
      <p class="auth-subtitle">join outlet today</p>
      <div id="register-error" class="error hidden"></div>
      <form id="register-form">
        <input type="email" class="input" placeholder="email" id="register-email" required>
        <input type="text" class="input" placeholder="username" id="register-username" required>
        <input type="password" class="input" placeholder="password" id="register-password" required>
        <button type="submit" class="btn">register</button>
      </form>
      <button class="btn-link" onclick="showLogin()">already have an account? login</button>
    </div>
  </div>

  <div id="app" class="app hidden">
    <div class="sidebar">
      <div class="sidebar-header">
        <span>outlet</span>
        <button class="settings-btn" onclick="openSettings()">⚙</button>
      </div>
      <div class="sidebar-content">
        <div class="online-header" id="online-count">online — 0</div>
        <div id="online-users"></div>
      </div>
      <div class="sidebar-footer">
        <div>
          <div id="current-username"></div>
          <div class="user-info" id="current-email"></div>
        </div>
        <button class="logout-btn" onclick="logout()">logout</button>
      </div>
    </div>
    <div class="chat">
      <div class="chat-header"># general</div>
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <div class="typing-indicator" id="typing"></div>
        <form id="message-form">
          <input type="text" class="message-input" placeholder="message #general" id="message-input" autocomplete="off">
        </form>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <span>settings</span>
        <button class="modal-close" onclick="closeSettings()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="setting-group">
          <div class="setting-label">profile picture</div>
          <div class="avatar-upload">
            <div class="avatar-preview" id="avatar-preview"></div>
            <div>
              <input type="file" id="avatar-input" class="file-input" accept="image/*" onchange="uploadAvatar()">
              <button class="upload-btn" onclick="document.getElementById('avatar-input').click()">choose file</button>
              <div class="setting-description">max 5MB</div>
            </div>
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label" for="display-name-input">display name</label>
          <input type="text" id="display-name-input" class="input" maxlength="32">
        </div>

        <div class="setting-group">
          <label class="setting-label" for="bio-input">bio</label>
          <div class="setting-description">max 200 characters</div>
          <input type="text" id="bio-input" class="input" maxlength="200">
        </div>

        <div class="setting-group">
          <div class="setting-label">theme</div>
          <div class="theme-grid">
            <div class="theme-option" data-theme="dark" onclick="selectTheme('dark')">dark</div>
            <div class="theme-option" data-theme="light" onclick="selectTheme('light')">light</div>
            <div class="theme-option" data-theme="midnight" onclick="selectTheme('midnight')">midnight</div>
            <div class="theme-option" data-theme="ocean" onclick="selectTheme('ocean')">ocean</div>
          </div>
        </div>

        <button class="btn" onclick="saveSettings()">save changes</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const API = window.location.origin;
    let socket = null;
    let currentUser = null;
    let typingTimeout = null;
    let typingUsers = new Set();
    let isInitialized = false;
    let selectedTheme = 'dark';

    function showView(viewId) {
      ['loading', 'login', 'register', 'app'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(viewId).classList.remove('hidden');
    }

    function showError(formId, message) {
      const errorEl = document.getElementById(`${formId}-error`);
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
    }

    function hideError(formId) {
      document.getElementById(`${formId}-error`).classList.add('hidden');
    }

    function showLogin() {
      showView('login');
      hideError('login');
    }

    function showRegister() {
      showView('register');
      hideError('register');
    }

    function setTheme(theme) {
      selectedTheme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      document.querySelectorAll('.theme-option').forEach(el => {
        el.classList.toggle('active', el.dataset.theme === theme);
      });
    }

    function selectTheme(theme) {
      setTheme(theme);
    }

    async function openSettings() {
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`${API}/api/profile`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const profile = await res.json();

        document.getElementById('display-name-input').value = profile.display_name || '';
        document.getElementById('bio-input').value = profile.bio || '';
        setTheme(profile.theme || 'dark');
        
        const preview = document.getElementById('avatar-preview');
        if (profile.avatar_url) {
          preview.innerHTML = `<img src="${profile.avatar_url}" alt="avatar">`;
        } else {
          preview.textContent = (profile.display_name || profile.username)[0].toUpperCase();
        }

        document.getElementById('settings-modal').classList.remove('hidden');
      } catch (err) {
        console.error(err);
      }
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.add('hidden');
    }

    async function uploadAvatar() {
      const input = document.getElementById('avatar-input');
      const file = input.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('avatar', file);

      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`${API}/api/profile/avatar`, {
          method: 'POST',
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });

        const data = await res.json();
        if (res.ok) {
          const preview = document.getElementById('avatar-preview');
          preview.innerHTML = `<img src="${data.avatar_url}" alt="avatar">`;
          currentUser = data;
          localStorage.setItem('user', JSON.stringify(data));
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function saveSettings() {
      const token = localStorage.getItem('token');
      const displayName = document.getElementById('display-name-input').value;
      const bio = document.getElementById('bio-input').value;

      try {
        const res = await fetch(`${API}/api/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({
            display_name: displayName,
            bio: bio,
            theme: selectedTheme
          })
        });

        const data = await res.json();
        if (res.ok) {
          currentUser = data;
          localStorage.setItem('user', JSON.stringify(data));
          document.getElementById('current-username').textContent = data.display_name || data.username;
          setTheme(data.theme || 'dark');
          closeSettings();
          
          if (socket) {
            socket.disconnect();
            initSocket(token);
          }
        }
      } catch (err) {
        console.error(err);
      }
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      if (socket) {
        socket.disconnect();
        socket = null;
      }
      currentUser = null;
      typingUsers.clear();
      document.getElementById('messages').innerHTML = '';
      showLogin();
    }

    function addMessage(msg) {
      const messagesEl = document.getElementById('messages');
      const msgEl = document.createElement('div');
      msgEl.className = 'message';
      
      const displayName = msg.display_name || msg.username;
      const avatarContent = msg.avatar_url 
        ? `<img src="${msg.avatar_url}" alt="avatar">`
        : displayName[0].toUpperCase();
      
      msgEl.innerHTML = `
        <div class="avatar">${avatarContent}</div>
        <div class="message-content">
          <div class="message-header">
            <span class="username">${displayName}</span>
            <span class="timestamp">${new Date(msg.created_at).toLocaleTimeString()}</span>
          </div>
          <div>${msg.content}</div>
        </div>
      `;
      messagesEl.appendChild(msgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function updateOnlineUsers(users) {
      document.getElementById('online-count').textContent = `online — ${users.length}`;
      const container = document.getElementById('online-users');
      container.innerHTML = users.map(u => `
        <div class="online-user">
          <div class="online-dot"></div>
          ${typeof u === 'string' ? u : (u.display_name || u.username)}
        </div>
      `).join('');
    }

    function updateTyping() {
      const typingEl = document.getElementById('typing');
      if (typingUsers.size === 0) {
        typingEl.textContent = '';
        return;
      }
      const names = Array.from(typingUsers).join(', ');
      typingEl.textContent = `${names} ${typingUsers.size === 1 ? 'is' : 'are'} typing...`;
    }

    function initSocket(token) {
      if (socket) {
        socket.disconnect();
      }

      socket = io(API, {
        auth: { token },
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5
      });

      socket.on('connect', () => {
        console.log('connected');
      });

      socket.on('disconnect', () => {
        console.log('disconnected');
      });

      socket.on('message', addMessage);

      socket.on('online', updateOnlineUsers);

      socket.on('typing', (data) => {
        if (data.typing) {
          typingUsers.add(data.username);
        } else {
          typingUsers.delete(data.username);
        }
        updateTyping();
      });
    }

    async function loadMessages(token) {
      try {
        const res = await fetch(`${API}/api/messages`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!res.ok) {
          throw new Error('failed to load messages');
        }
        
        const messages = await res.json();
        messages.forEach(addMessage);
      } catch (err) {
        console.error('load messages error:', err);
      }
    }

    async function initApp(token, user) {
      try {
        currentUser = user;
        document.getElementById('current-username').textContent = user.display_name || user.username;
        document.getElementById('current-email').textContent = user.email;
        setTheme(user.theme || 'dark');
        
        initSocket(token);
        await loadMessages(token);
        
        showView('app');
        isInitialized = true;
      } catch (err) {
        console.error('init error:', err);
        logout();
      }
    }

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError('login');

      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      try {
        const res = await fetch(`${API}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (res.ok) {
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          await initApp(data.token, data.user);
        } else {
          showError('login', data.error);
        }
      } catch (err) {
        showError('login', 'server error');
      }
    });

    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError('register');

      const email = document.getElementById('register-email').value;
      const username = document.getElementById('register-username').value;
      const password = document.getElementById('register-password').value;

      try {
        const res = await fetch(`${API}/api/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, username, password })
        });

        const data = await res.json();

        if (res.ok) {
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          await initApp(data.token, data.user);
        } else {
          showError('register', data.error);
        }
      } catch (err) {
        showError('register', 'server error');
      }
    });

    document.getElementById('message-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const input = document.getElementById('message-input');
      const content = input.value.trim();

      if (!content || !socket) return;

      socket.emit('message', { content });
      input.value = '';
      socket.emit('typing', false);
    });

    document.getElementById('message-input').addEventListener('input', (e) => {
      if (!socket) return;

      socket.emit('typing', true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit('typing', false);
      }, 1000);
    });

    async function autoLogin() {
      const token = localStorage.getItem('token');
      const userStr = localStorage.getItem('user');
      
      if (!token || !userStr) {
        showLogin();
        return;
      }

      try {
        const user = JSON.parse(userStr);
        
        const res = await fetch(`${API}/api/messages`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (res.ok) {
          await initApp(token, user);
        } else {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          showLogin();
        }
      } catch (err) {
        console.error('auto login error:', err);
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        showLogin();
      }
    }

    setTheme('dark');
    autoLogin();
  </script>
</body>
</html>
